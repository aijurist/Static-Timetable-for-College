<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Enhanced Timetable Visualizer - 6 Day Schedule</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --theory-color: #60a5fa; --theory-border: #3b82f6;
            --tutorial-color: #34d399; --tutorial-border: #10b981;
            --lab-color: #a78bfa; --lab-border: #8b5cf6;
            --lecture-color: #fb7185; --lecture-border: #f43f5e;
            --header-bg: #1f2937; --cell-bg: #374151; --border-color: #4b5563;
            --hover-bg: #4b5563; --text-primary: #f9fafb; --text-secondary: #d1d5db;
            --bg-primary: #111827; --bg-secondary: #1f2937;
            --accent-color: #60a5fa; --success-color: #10b981; --warning-color: #f59e0b;
        }
        body.light-theme {
            --header-bg: #ffffff; --cell-bg: #f9fafb; --border-color: #cbd5e1;
            --hover-bg: #e2e8f0; --text-primary: #1f2937; --text-secondary: #475569;
            --bg-primary: #f1f5f9; --bg-secondary: #ffffff;
        }
        body { 
            font-family: 'Roboto', sans-serif; margin: 0; padding: 20px; 
            background-color: var(--bg-primary); color: var(--text-primary); 
            touch-action: manipulation; transition: all 0.3s ease;
        }
        body.fullscreen { padding: 0; overflow: hidden; }
        
        .container { 
            max-width: 1800px; margin: 0 auto; background: var(--bg-secondary); 
            padding: 30px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); 
            border: 1px solid var(--border-color); transition: all 0.3s ease;
        }
        .container.fullscreen { 
            max-width: 100%; height: 100vh; border-radius: 0; 
            padding: 15px; margin: 0; border: none; display: flex; flex-direction: column;
        }
        
        h1 { 
            color: var(--text-primary); margin-bottom: 25px; font-weight: 500; 
            font-size: 2.2em; display: flex; align-items: center; gap: 15px;
        }
        .title-actions {
            margin-left: auto; display: flex; gap: 10px; align-items: center;
        }
        
        .controls { 
            margin-bottom: 20px; display: flex; gap: 20px; align-items: center; 
            flex-wrap: wrap; background: var(--header-bg); padding: 15px; 
            border-radius: 10px; border: 1px solid var(--border-color);
        }
        .controls.fullscreen { margin-bottom: 10px; padding: 10px; }
        
        .control-group { display: flex; gap: 10px; align-items: center; }
        .control-group label { color: var(--text-secondary); font-weight: 500; min-width: 80px; }
        
        select, .toggle-btn, input[type="text"], .icon-btn { 
            padding: 8px 12px; border: 1px solid var(--border-color); 
            border-radius: 8px; background-color: var(--cell-bg); 
            font-size: 14px; color: var(--text-primary); cursor: pointer; 
            min-width: 120px; transition: all 0.2s;
        }
        .icon-btn { 
            min-width: auto; width: 40px; height: 40px; display: flex; 
            align-items: center; justify-content: center; font-size: 16px;
        }
        .icon-btn:hover { background-color: var(--hover-bg); transform: scale(1.05); }
        
        input[type="text"]:focus { 
            outline: none; border-color: var(--theory-color); 
            box-shadow: 0 0 0 2px rgba(96,165,250,0.2); 
        }
        
        .view-toggle { display: flex; border-radius: 6px; overflow: hidden; border: 1px solid var(--border-color); }
        .view-toggle .toggle-btn { border: none; border-radius: 0; }
        .view-toggle .toggle-btn:not(:last-child) { border-right: 1px solid var(--border-color); }
        .toggle-btn.active { background-color: var(--theory-color); color: var(--bg-primary); border-color: var(--theory-border); }
        
        .zoom-controls { display: flex; gap: 5px; align-items: center; margin-left: 10px; }
        .zoom-btn { width: 32px; height: 32px; padding: 0; min-width: auto; display: flex; align-items: center; justify-content: center; }
        .zoom-level { min-width: 60px; text-align: center; font-size: 12px; color: var(--text-secondary); padding: 4px 8px; }
        
        .legend { display: flex; gap: 15px; margin-bottom: 20px; padding: 15px; background-color: var(--header-bg); border-radius: 8px; flex-wrap: wrap; border: 1px solid var(--border-color); }
        .legend.fullscreen { margin-bottom: 10px; padding: 10px; gap: 10px; }
        .legend-item { display: flex; align-items: center; gap: 8px; }
        .legend-color { width: 20px; height: 20px; border-radius: 4px; }
        .legend-text { font-size: 0.9em; color: var(--text-secondary); }
        
        #timetableContainer { position: relative; width: 100%; overflow: auto; border: 1px solid var(--border-color); border-radius: 8px; transition: all 0.3s ease; flex-grow: 1; }
        #timetableContainer.fullscreen { height: auto; border-radius: 0; max-height: none; }
        
        .timetable { display: grid; grid-template-columns: 80px repeat(6, 1fr); min-width: 1200px; width: 100%; transform-origin: top left; transition: transform 0.2s ease; }
        body.compact .timetable { min-width: 1000px; }
        
        .header { background-color: var(--header-bg); padding: 12px; text-align: center; font-weight: 500; border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 20; }
        .header:not(:last-child) { border-right: 1px solid var(--border-color); }
        
        .time-column { position: sticky; left: 0; background-color: var(--header-bg); border-right: 1px solid var(--border-color); z-index: 15; }
        .day-column, .time-column { height: 1800px; position: relative; transition: height 0.3s ease; }
        body.compact .day-column, body.compact .time-column { height: 1200px; }
        
        .time-marker { position: absolute; width: 100%; text-align: right; padding-right: 10px; font-size: 0.8em; color: var(--text-secondary); transform: translateY(-50%); box-sizing: border-box; }
        .time-marker::after { content: ''; position: absolute; right: 0; top: 50%; width: 5px; height: 1px; background-color: var(--border-color); }
        
        .day-column { background-color: var(--cell-bg); border-right: 1px solid var(--border-color); background-image: linear-gradient(var(--border-color) 1px, transparent 1px); background-size: 100% 200px; transition: background-size 0.3s ease; }
        body.compact .day-column { background-size: 100% calc(1200px / 9); }
        .day-column:last-child { border-right: none; }
        
        .lesson-block { position: absolute; box-sizing: border-box; margin: 0 2px; padding: 6px; border-radius: 4px; color: white; cursor: pointer; transition: all 0.2s; font-size: 0.8em; line-height: 1.3; overflow: hidden; display: flex; flex-direction: column; justify-content: flex-start; z-index: 10; }
        .lesson-block:hover { transform: translateY(-1px) scale(1.02); box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 11; }
        .lesson-block-content > div { margin-bottom: 2px; }
        .lesson-course { font-weight: 600; }
        .lesson-details, .lesson-batch { font-size: 0.9em; opacity: 0.9; }
        
        .theory { background-color: var(--theory-color); border: 1px solid var(--theory-border); }
        .lecture { background-color: var(--lecture-color); border: 1px solid var(--lecture-border); }
        .tutorial { background-color: var(--tutorial-color); border: 1px solid var(--tutorial-border); }
        .lab { background-color: var(--lab-color); border: 1px solid var(--lab-border); }
        
        .tooltip { position: fixed; background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%); color: var(--text-primary); padding: 16px; border-radius: 12px; font-size: 14px; z-index: 1000; box-shadow: 0 12px 32px rgba(0,0,0,0.6); max-width: 400px; min-width: 280px; display: none; border: 2px solid rgba(96,165,250,0.3); backdrop-filter: blur(10px); pointer-events: none; }
        .tooltip-title { font-weight: 600; font-size: 16px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid rgba(96,165,250,0.3); text-align: center; }
        .tooltip-content { display: grid; gap: 6px; }
        .tooltip-row { display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; padding: 2px 0; }
        .tooltip-label { color: var(--text-secondary); font-weight: 500; min-width: 80px; flex-shrink: 0; }
        .tooltip-value { font-weight: 500; text-align: right; flex-grow: 1; }
        
        .error-message { color: #fca5a5; background-color: #1e1b22; border: 1px solid #7f1d1d; padding: 20px; border-radius: 8px; margin: 20px auto; text-align: center; max-width: 800px; }
        
        .analytics-container { margin-top: 20px; transition: all 0.3s ease; }
        .analytics-container.fullscreen { margin-top: 10px; }
        
        .analytics-menu-bar { background: var(--bg-secondary); border-radius: 10px; border: 1px solid var(--border-color); margin-bottom: 20px; box-shadow: 0 3px 12px rgba(0,0,0,0.08); overflow: hidden; }
        .analytics-menu-bar.fullscreen { margin-bottom: 10px; border-radius: 6px; }
        
        .menu-header { display: flex; justify-content: space-between; align-items: center; padding: 0 20px; background: var(--header-bg); border-bottom: 1px solid var(--border-color); }
        .menu-title { font-weight: 600; font-size: 1em; margin: 0; padding: 15px 0; text-transform: uppercase; }
        .menu-title.fullscreen { font-size: 0.9em; padding: 12px 0; }
        
        .analytics-toggle-btn { background: var(--theory-color); color: white; border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 0.85em; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
        .analytics-toggle-btn .toggle-icon { transition: transform 0.3s ease; }
        .analytics-toggle-btn.expanded .toggle-icon { transform: rotate(180deg); }
        
        .analytics-tabs { display: flex; background: var(--header-bg); border-bottom: 2px solid var(--border-color); overflow-x: auto; }
        .analytics-tab { flex: 1; padding: 15px 25px; background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 0.9em; font-weight: 600; transition: all 0.2s; border-bottom: 3px solid transparent; text-transform: uppercase; }
        .analytics-tab.active { color: var(--text-primary); border-bottom-color: var(--theory-color); background: rgba(96,165,250,0.08); }
        
        .analytics-panels { padding: 0; max-height: 0; overflow: hidden; transition: all 0.4s ease-in-out; }
        .analytics-panels.expanded { max-height: 70vh; padding: 20px; overflow-y: auto; }
        .container.fullscreen .analytics-panels.expanded { max-height: 200px; }
        
        .analytics-panel { display: none; animation: fadeIn 0.4s ease-in; }
        .analytics-panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stats-card { background: var(--cell-bg); padding: 20px 16px; border-radius: 8px; border: 1px solid var(--border-color); text-align: center; transition: all 0.2s ease; }
        .stats-card:hover { border-color: var(--theory-color); transform: translateY(-2px); }
        .stats-card-value { font-size: 2.2em; font-weight: 700; color: var(--theory-color); margin-bottom: 6px; }
        .stats-card-label { color: var(--text-secondary); font-size: 0.85em; text-transform: uppercase; }
        
        .analytics-section { margin-bottom: 30px; }
        .analytics-section h4 { margin: 0 0 12px 0; color: var(--text-primary); font-size: 1em; font-weight: 600; padding-bottom: 8px; border-bottom: 1px solid var(--border-color); }
        .teacher-item, .stat-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(75, 85, 99, 0.2); }
        .teacher-item:last-child, .stat-item:last-child { border-bottom: none; }
        .stat-label, .teacher-name { color: var(--text-secondary); font-size: 0.95em; }
        .stat-value, .teacher-load { color: var(--text-primary); font-weight: 700; }
        .workload-high { color: #ef4444; } 
        .workload-medium { color: #f59e0b; } 
        .workload-normal { color: #10b981; }
        
        .nav-panel { position: fixed; top: 20px; right: 20px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); z-index: 1001; display: none; min-width: 200px; }
        .nav-panel.show { display: block; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        
        .nav-item { display: flex; align-items: center; gap: 10px; padding: 8px 12px; border-radius: 6px; cursor: pointer; transition: all 0.2s; color: var(--text-secondary); font-size: 14px; }
        .nav-item:hover { background: var(--hover-bg); color: var(--text-primary); }
        
        #currentTimeIndicator { position: absolute; left: 80px; width: calc(100% - 80px); height: 2px; background-color: #ef4444; z-index: 25; display: none; transition: top 0.3s ease; pointer-events: none; }
        #currentTimeIndicator::before { content: 'NOW'; position: absolute; left: -70px; top: 50%; transform: translateY(-50%); background-color: #ef4444; color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; }

        @media print {
            body { padding: 0; }
            .controls, .title-actions, .legend, .analytics-container, .nav-panel, #currentTimeIndicator { display: none !important; }
            .container { padding: 0; border: none; box-shadow: none; border-radius: 0; }
            #timetableContainer { max-height: none; overflow: visible; border: none; }
            .timetable { min-width: 100%; transform: scale(1) !important; }
        }

        @media (max-width: 768px) {
            body { padding: 10px; }
            body.fullscreen { padding: 0; }
            .container { padding: 15px; }
            .container.fullscreen { padding: 10px; }
            .controls { flex-direction: column; gap: 10px; align-items: stretch; }
            .day-column, .time-column { height: 1600px; }
            .day-column { background-size: 100% calc(1600px / 9); }
            .lesson-block { font-size: 0.75em; padding: 4px; border-radius: 3px; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .analytics-tab { font-size: 0.8em; padding: 12px 15px; }
            h1 { font-size: 1.8em; }
            .title-actions { flex-direction: row; align-items: center; }
        }
    </style>
</head>
<body>
    <div class="container" id="mainContainer">
        <h1>
            Enhanced Timetable Visualizer
            <div class="title-actions">
                <div class="zoom-controls">
                    <button class="zoom-btn icon-btn" onclick="adjustZoom(-0.1)">-</button>
                    <div class="zoom-level" id="zoomLevel">100%</div>
                    <button class="zoom-btn icon-btn" onclick="adjustZoom(0.1)">+</button>
                </div>
                <button class="icon-btn" id="fullscreenBtn" onclick="toggleFullscreen()" title="Toggle Fullscreen (f)">‚õ∂</button>
                <button class="icon-btn" id="navToggle" onclick="toggleNavPanel()" title="Navigation">‚ò∞</button>
            </div>
        </h1>
        
        <div class="controls" id="controlsPanel">
            <div class="control-group">
                <label>Schedule:</label>
                <div class="view-toggle">
                    <button class="toggle-btn" id="theoryBtn" onclick="setScheduleType('theory')">Theory</button>
                    <button class="toggle-btn" id="labBtn" onclick="setScheduleType('lab')">Labs</button>
                    <button class="toggle-btn active" id="combinedBtn" onclick="setScheduleType('combined')">Combined</button>
                </div>
            </div>
            <div class="control-group">
                <label>View:</label>
                <select id="viewType">
                    <option value="teacher">Teacher View</option>
                    <option value="group">Student Group View</option>
                </select>
            </div>
            <div class="control-group">
                <select id="entitySelector"></select>
            </div>
            <div class="control-group" id="searchGroup">
                <label>Search:</label>
                <input type="text" id="entitySearch" placeholder="Type name...">
            </div>
            <div class="control-group" style="margin-left:auto;">
                <button id="themeToggle" class="toggle-btn">Light Mode</button>
                <button class="icon-btn" onclick="resetView()" title="Reset View (r)">üîÑ</button>
                <button class="icon-btn" onclick="exportView()" title="Export/Print (p)">üì§</button>
            </div>
        </div>

        <div class="legend" id="legend"></div>

        <div class="analytics-container" id="analyticsContainer">
            <div class="analytics-menu-bar" id="analyticsMenuBar">
                <div class="menu-header">
                    <h2 class="menu-title" id="menuTitle">Analytics Dashboard</h2>
                    <button class="analytics-toggle-btn" onclick="toggleAnalytics()">
                        <span class="toggle-icon">‚ñº</span>
                        <span>Show Analytics</span>
                    </button>
                </div>
                <div class="analytics-tabs">
                    <button class="analytics-tab active" onclick="switchAnalyticsTab(event, 'teachers')">Teachers</button>
                    <button class="analytics-tab" onclick="switchAnalyticsTab(event, 'departments')">Departments</button>
                    <button class="analytics-tab" onclick="switchAnalyticsTab(event, 'schedule')">Schedule Stats</button>
                </div>
                <div class="analytics-panels" id="analyticsPanels">
                    <div id="teachers-panel" class="analytics-panel active">
                        <div class="analytics-section">
                            <h4>Teacher Overview</h4>
                            <div id="teacher-overview-stats" class="stats-grid"></div>
                        </div>
                        <div class="analytics-section">
                            <h4>Workload Distribution (Top 15)</h4>
                            <div id="teacher-workload"></div>
                        </div>
                    </div>
                    <div id="departments-panel" class="analytics-panel">
                         <div class="analytics-section">
                            <h4>Department Overview</h4>
                            <div id="department-overview-stats" class="stats-grid"></div>
                        </div>
                    </div>
                    <div id="schedule-panel" class="analytics-panel">
                        <div class="analytics-section">
                            <h4>General Statistics</h4>
                            <div id="schedule-stats" class="stats-grid"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="timetableContainer">
            <div class="timetable" id="timetable"></div>
            <div id="currentTimeIndicator"></div>
        </div>
    </div>
    
    <div class="nav-panel" id="navPanel">
        <div class="nav-item" onclick="quickJumpToTime('09:00')">üìÖ Jump to 9 AM</div>
        <div class="nav-item" onclick="quickJumpToTime('14:00')">üìÖ Jump to 2 PM</div>
        <div class="nav-item" onclick="focusCurrentTime()">üïê Focus Current Time</div>
        <div class="nav-item" onclick="toggleCompactMode()">üìè Toggle Compact Mode</div>
        <div class="nav-item" onclick="showKeyboardShortcuts()">‚å®Ô∏è Shortcuts</div>
    </div>
    
    <div class="tooltip" id="tooltip"></div>

    <script>
        const days = ["MONDAY", "TUESDAY", "WEDNESDAY", "THURSDAY", "FRIDAY", "SATURDAY"];
        const dayDisplayNames = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
        const TIMELINE_START_HOUR = 8;
        const TIMELINE_END_HOUR = 17;
        const TOTAL_HOURS = TIMELINE_END_HOUR - TIMELINE_START_HOUR;
        const TOTAL_MINUTES = TOTAL_HOURS * 60;
        
        let timetableData = null;
        let currentScheduleType = 'combined';
        let currentTheme = localStorage.getItem('theme') || 'dark';
        let isFullscreen = false;
        let currentZoom = 1;
        let isCompactMode = false;

        function applyTheme(theme) {
            document.body.classList.toggle('light-theme', theme === 'light');
            document.getElementById('themeToggle').textContent = theme === 'light' ? 'Dark Mode' : 'Light Mode';
            localStorage.setItem('theme', theme);
            currentTheme = theme;
        }

        function toggleTheme() {
            applyTheme(currentTheme === 'light' ? 'dark' : 'light');
        }

        function toggleFullscreen() {
            isFullscreen = !isFullscreen;
            const container = document.getElementById('mainContainer');
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            
            document.body.classList.toggle('fullscreen', isFullscreen);
            container.classList.toggle('fullscreen', isFullscreen);
            document.getElementById('timetableContainer').classList.toggle('fullscreen', isFullscreen);
            document.getElementById('analyticsContainer').classList.toggle('fullscreen', isFullscreen);
            document.getElementById('controlsPanel').classList.toggle('fullscreen', isFullscreen);
            document.getElementById('legend').classList.toggle('fullscreen', isFullscreen);
            document.getElementById('analyticsMenuBar').classList.toggle('fullscreen', isFullscreen);
            document.getElementById('menuTitle').classList.toggle('fullscreen', isFullscreen);

            if (isFullscreen) {
                fullscreenBtn.innerHTML = '‚õó';
                fullscreenBtn.title = 'Exit Fullscreen (f)';
            } else {
                fullscreenBtn.innerHTML = '‚õ∂';
                fullscreenBtn.title = 'Toggle Fullscreen (f)';
            }
        }

        function adjustZoom(delta) {
            currentZoom = Math.max(0.5, Math.min(2, currentZoom + delta));
            document.getElementById('timetable').style.transform = `scale(${currentZoom})`;
            document.getElementById('zoomLevel').textContent = `${Math.round(currentZoom * 100)}%`;
        }

        function resetView() {
            currentZoom = 1;
            document.getElementById('timetable').style.transform = 'scale(1)';
            document.getElementById('zoomLevel').textContent = '100%';
            document.getElementById('timetableContainer').scrollTo({ top: 0, left: 0, behavior: 'smooth' });
        }

        function toggleNavPanel() {
            const navPanel = document.getElementById('navPanel');
            navPanel.classList.toggle('show');
            if (navPanel.classList.contains('show')) {
                setTimeout(() => {
                    document.addEventListener('click', function closeNav(e) {
                        if (!navPanel.contains(e.target) && !document.getElementById('navToggle').contains(e.target)) {
                            navPanel.classList.remove('show');
                            document.removeEventListener('click', closeNav);
                        }
                    }, { once: true });
                }, 0);
            }
        }

        function quickJumpToTime(timeStr) {
            const [hours] = timeStr.split(':').map(Number);
            const totalHeight = document.querySelector('.day-column').offsetHeight;
            const targetPosition = ((hours - TIMELINE_START_HOUR) / TOTAL_HOURS) * totalHeight;
            
            document.getElementById('timetableContainer').scrollTo({
                top: targetPosition - 50,
                behavior: 'smooth'
            });
            document.getElementById('navPanel').classList.remove('show');
        }

        function focusCurrentTime() {
            const now = new Date();
            const currentDayIndex = now.getDay() - 1; 
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            const indicator = document.getElementById('currentTimeIndicator');

            if (currentDayIndex >= 0 && currentDayIndex < 6 && currentHour >= TIMELINE_START_HOUR && currentHour < TIMELINE_END_HOUR) {
                const minutesFromStart = (currentHour - TIMELINE_START_HOUR) * 60 + currentMinute;
                const totalHeight = document.querySelector('.day-column').offsetHeight;
                const topPercent = (minutesFromStart / TOTAL_MINUTES) * 100;

                indicator.style.display = 'block';
                indicator.style.top = `${topPercent}%`;
                
                quickJumpToTime(`${currentHour}:${currentMinute}`);
            } else {
                indicator.style.display = 'none';
            }
             document.getElementById('navPanel')?.classList.remove('show');
        }

        function toggleCompactMode() {
            isCompactMode = !isCompactMode;
            document.body.classList.toggle('compact', isCompactMode);
            document.getElementById('navPanel').classList.remove('show');
        }

        function showKeyboardShortcuts() {
            alert(`Keyboard Shortcuts:\n\n- f: Toggle Fullscreen\n- r: Reset View\n- p: Print/Export View\n- +/-: Zoom In/Out\n- Esc: Close Navigation Panel`);
             document.getElementById('navPanel').classList.remove('show');
        }

        function exportView() {
            window.print();
        }

        function setScheduleType(type) {
            currentScheduleType = type;
            document.querySelectorAll('.view-toggle .toggle-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`${type}Btn`).classList.add('active');
            updateLegend();
            filterLessons();
        }

        function updateLegend() {
            const legendItems = [
                { type: 'theory', color: 'var(--theory-color)', text: 'Theory' },
                { type: 'lecture', color: 'var(--lecture-color)', text: 'Lecture' },
                { type: 'tutorial', color: 'var(--tutorial-color)', text: 'Tutorial' },
                { type: 'lab', color: 'var(--lab-color)', text: 'Lab' }
            ];
            document.getElementById('legend').innerHTML = legendItems
                .map(item => `<div class="legend-item"><div class="legend-color" style="background-color: ${item.color};"></div><span class="legend-text">${item.text}</span></div>`)
                .join('');
        }

        function createTimetableGrid() {
            const timetable = document.getElementById('timetable');
            timetable.innerHTML = '';
            const timeColumn = document.createElement('div');
            timeColumn.className = 'time-column';
            timetable.appendChild(document.createElement('div')).className = 'header'; // Top-left empty cell
            dayDisplayNames.forEach(dayName => {
                const header = document.createElement('div');
                header.className = 'header';
                header.textContent = dayName;
                timetable.appendChild(header);
            });
            timetable.appendChild(timeColumn);
            for (let hour = TIMELINE_START_HOUR; hour <= TIMELINE_END_HOUR; hour++) {
                const marker = document.createElement('div');
                marker.className = 'time-marker';
                marker.textContent = `${hour}:00`;
                marker.style.top = `${((hour - TIMELINE_START_HOUR) * 60 / TOTAL_MINUTES) * 100}%`;
                timeColumn.appendChild(marker);
            }
            days.forEach(day => {
                const dayColumn = document.createElement('div');
                dayColumn.className = 'day-column';
                dayColumn.dataset.day = day;
                timetable.appendChild(dayColumn);
            });
        }
        
        function parseTime(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function showTooltip(event, lesson) {
            const tooltip = document.getElementById('tooltip');
            tooltip.style.display = 'block';
            tooltip.innerHTML = `
                <div class="tooltip-title">${lesson.course}</div>
                <div class="tooltip-content">
                    <div class="tooltip-row"><span class="tooltip-label">Teacher:</span><span class="tooltip-value">${lesson.teacher}</span></div>
                    <div class="tooltip-row"><span class="tooltip-label">Group:</span><span class="tooltip-value">${lesson.group}</span></div>
                    ${lesson.batch ? `<div class="tooltip-row"><span class="tooltip-label">Batch:</span><span class="tooltip-value">${lesson.batch}</span></div>` : ''}
                    <div class="tooltip-row"><span class="tooltip-label">Room:</span><span class="tooltip-value">${lesson.room}</span></div>
                    <div class="tooltip-row"><span class="tooltip-label">Time:</span><span class="tooltip-value">${lesson.startTime} - ${lesson.endTime}</span></div>
                    <div class="tooltip-row"><span class="tooltip-label">Type:</span><span class="tooltip-value">${lesson.type.charAt(0).toUpperCase() + lesson.type.slice(1)}</span></div>
                </div>
            `;
            positionTooltip(event);
        }
        
        function hideTooltip() { document.getElementById('tooltip').style.display = 'none'; }
        
        function positionTooltip(event) {
            const tooltip = document.getElementById('tooltip');
            if(tooltip.style.display === 'none') return;
            const { clientX, clientY } = event;
            const { innerWidth, innerHeight } = window;
            const tooltipRect = tooltip.getBoundingClientRect();
            tooltip.style.left = `${clientX + 15 + tooltipRect.width > innerWidth ? clientX - 15 - tooltipRect.width : clientX + 15}px`;
            tooltip.style.top = `${clientY + 15 + tooltipRect.height > innerHeight ? clientY - 15 - tooltipRect.height : clientY + 15}px`;
        }

        function createLessonBlock(lesson, layout) {
            const block = document.createElement('div');
            block.className = `lesson-block ${lesson.type.toLowerCase()}`;
            const startMinutes = parseTime(lesson.startTime) - (TIMELINE_START_HOUR * 60);
            const endMinutes = parseTime(lesson.endTime) - (TIMELINE_START_HOUR * 60);
            block.style.top = `${(startMinutes / TOTAL_MINUTES) * 100}%`;
            block.style.height = `${((endMinutes - startMinutes) / TOTAL_MINUTES) * 100}%`;
            block.style.left = `${layout.left}%`;
            block.style.width = `calc(${layout.width}% - 4px)`;
            block.innerHTML = `
                <div class="lesson-block-content">
                   <div class="lesson-course">${lesson.course}</div>
                   <div class="lesson-details">${lesson.teacher}</div>
                   <div class="lesson-details">${lesson.room}</div>
                   ${lesson.batch ? `<div class="lesson-batch">${lesson.batch}</div>` : ''}
                </div>`;
            block.addEventListener('mousemove', (e) => showTooltip(e, lesson));
            block.addEventListener('mouseleave', hideTooltip);
            return block;
        }

        function displayLessons(lessons) {
            document.querySelectorAll('.day-column').forEach(col => col.innerHTML = '');
            const lessonsByDay = days.reduce((acc, day) => ({ ...acc, [day]: [] }), {});
            lessons.forEach(lesson => {
                const dayKey = lesson.day.toUpperCase();
                if (lessonsByDay[dayKey]) lessonsByDay[dayKey].push(lesson);
            });

            Object.values(lessonsByDay).forEach(dayLessons => {
                if (dayLessons.length === 0) return;

                const dayColumn = document.querySelector(`.day-column[data-day="${dayLessons[0].day.toUpperCase()}"]`);
                const sortedLessons = dayLessons.sort((a, b) => parseTime(a.startTime) - parseTime(b.startTime));
                
                let lessonGroups = [];
                sortedLessons.forEach(lesson => {
                    let placed = false;
                    for (let group of lessonGroups) {
                        const lastLessonInGroup = group[group.length - 1];
                        if (parseTime(lesson.startTime) >= parseTime(lastLessonInGroup.endTime)) {
                            group.push(lesson);
                            placed = true;
                            break;
                        }
                    }
                    if (!placed) {
                        lessonGroups.push([lesson]);
                    }
                });

                const layoutInfo = new Map();
                for (let i = 0; i < sortedLessons.length; i++) {
                    const lesson = sortedLessons[i];
                    let overlaps = [lesson];
                    for (let j = 0; j < sortedLessons.length; j++) {
                        if (i === j) continue;
                        const other = sortedLessons[j];
                        if (parseTime(lesson.endTime) > parseTime(other.startTime) && parseTime(lesson.startTime) < parseTime(other.endTime)) {
                            overlaps.push(other);
                        }
                    }
                    
                    const columns = [[]];
                    overlaps.sort((a,b) => parseTime(a.startTime) - parseTime(b.startTime));
                    overlaps.forEach(ovLesson => {
                        let placed = false;
                        for(let col of columns){
                            if(col.length === 0 || parseTime(ovLesson.startTime) >= parseTime(col[col.length-1].endTime)){
                                col.push(ovLesson);
                                placed = true;
                                break;
                            }
                        }
                        if(!placed){
                            columns.push([ovLesson]);
                        }
                    });

                    if (!layoutInfo.has(lesson.lessonId)) {
                         for(let c_idx=0; c_idx < columns.length; c_idx++){
                            let col = columns[c_idx];
                            for(let r_idx=0; r_idx < col.length; r_idx++){
                                let l = col[r_idx];
                                layoutInfo.set(l.lessonId, { width: 100 / columns.length, left: c_idx * (100 / columns.length) });
                            }
                         }
                    }
                }
                
                sortedLessons.forEach(lesson => {
                     if (layoutInfo.has(lesson.lessonId)) {
                        dayColumn.appendChild(createLessonBlock(lesson, layoutInfo.get(lesson.lessonId)));
                     }
                });
            });
        }

        function updateEntitySelector() {
            if (!timetableData) return;
            const selector = document.getElementById('entitySelector');
            const searchInput = document.getElementById('entitySearch');
            const viewType = document.getElementById('viewType').value;
            selector.innerHTML = '';
            selector.add(new Option(`All ${viewType === 'teacher' ? 'Teachers' : 'Groups'}`, ''));
            const entities = new Map();
            if (viewType === 'teacher') {
                searchInput.placeholder = 'Type teacher name...';
                timetableData.lessons.forEach(l => entities.set(l.teacherId, l.teacher));
            } else {
                searchInput.placeholder = 'Type group name...';
                timetableData.lessons.forEach(l => entities.set(l.groupId, l.group));
            }
            [...entities.entries()].sort((a, b) => a[1].localeCompare(b[1])).forEach(([id, name]) => selector.add(new Option(name, id)));
            selector.value = '';
        }

        function showErrorMessage(message) {
            document.getElementById('timetableContainer').innerHTML = `<div class="error-message"><h3>Timetable Data Error</h3><p>${message}</p></div>`;
            document.querySelector('.controls').style.display = 'none';
        }

        function filterLessons() {
            if (!timetableData) return;
            let lessons = timetableData.lessons;
            if (currentScheduleType === 'theory') {
                lessons = lessons.filter(l => ['theory', 'lecture', 'tutorial'].includes(l.type.toLowerCase()));
            } else if (currentScheduleType === 'lab') {
                lessons = lessons.filter(l => l.type.toLowerCase() === 'lab');
            }
            const viewType = document.getElementById('viewType').value;
            const selectedId = document.getElementById('entitySelector').value;
            if (selectedId) {
                lessons = lessons.filter(l => l[viewType === 'teacher' ? 'teacherId' : 'groupId'] === selectedId);
            }
            displayLessons(lessons);
            calculateAnalytics(lessons);
        }

        function setupSearch() {
            const searchInput = document.getElementById('entitySearch');
            const entitySelector = document.getElementById('entitySelector');
            searchInput.addEventListener('input', () => {
                const searchTerm = searchInput.value.toLowerCase();
                let found = false;
                for (const option of entitySelector.options) {
                    if (option.text.toLowerCase().includes(searchTerm)) {
                        entitySelector.value = option.value;
                        found = true;
                        break;
                    }
                }
                if (!found) entitySelector.value = '';
                filterLessons();
            });
            entitySelector.addEventListener('change', () => {
                const selectedOption = entitySelector.options[entitySelector.selectedIndex];
                searchInput.value = selectedOption.value ? selectedOption.text : '';
                filterLessons();
            });
        }
        
        function calculateAnalytics(lessons) {
            const analyticsContainer = document.querySelector('.analytics-container');
            if (!lessons || lessons.length === 0) {
                analyticsContainer.style.display = 'none';
                return;
            };
            analyticsContainer.style.display = 'block';

            const teacherData = new Map();
            const departmentData = new Map();
            const lessonsByDay = days.reduce((acc, day) => ({ ...acc, [day]: 0 }), {});
            let totalHours = 0;

            lessons.forEach(lesson => {
                const duration = (parseTime(lesson.endTime) - parseTime(lesson.startTime)) / 60;
                totalHours += duration;
                lessonsByDay[lesson.day.toUpperCase()]++;

                if (!teacherData.has(lesson.teacherId)) teacherData.set(lesson.teacherId, { name: lesson.teacher, hours: 0 });
                teacherData.get(lesson.teacherId).hours += duration;
                
                const dept = lesson.group.split('-')[0] || 'Unknown';
                if (!departmentData.has(dept)) departmentData.set(dept, { lessons: 0, hours:0, teachers: new Set() });
                departmentData.get(dept).lessons++;
                departmentData.get(dept).hours += duration;
                departmentData.get(dept).teachers.add(lesson.teacher);
            });

            const sortedTeachers = [...teacherData.values()].sort((a,b) => b.hours - a.hours);
            document.getElementById('teacher-overview-stats').innerHTML = `
                <div class="stats-card"><div class="stats-card-value">${teacherData.size}</div><div class="stats-card-label">Visible Teachers</div></div>
                <div class="stats-card"><div class="stats-card-value">${(totalHours / teacherData.size || 0).toFixed(1)}</div><div class="stats-card-label">Avg Hours/Teacher</div></div>`;
            document.getElementById('teacher-workload').innerHTML = sortedTeachers.slice(0, 15).map(t => {
                const loadClass = t.hours > 16 ? 'workload-high' : t.hours > 10 ? 'workload-medium' : 'workload-normal';
                return `<div class="teacher-item"><span class="teacher-name">${t.name}</span><span class="teacher-load ${loadClass}">${t.hours.toFixed(1)} hrs</span></div>`;
            }).join('') || '<div class="stat-item"><span class="stat-label">No teacher data to display.</span></div>';

            document.getElementById('department-overview-stats').innerHTML = [...departmentData.entries()].map(([name, data]) => `
                <div class="stats-card">
                    <div class="stats-card-value">${name}</div>
                    <div class="stats-card-label">${data.lessons} lessons, ${data.teachers.size} teachers</div>
                </div>`).join('') || '<div class="stat-item"><span class="stat-label">No department data.</span></div>';

            const busiestDay = Object.entries(lessonsByDay).sort((a,b) => b[1] - a[1])[0];
            document.getElementById('schedule-stats').innerHTML = `
                <div class="stats-card"><div class="stats-card-value">${lessons.length}</div><div class="stats-card-label">Total Lessons</div></div>
                <div class="stats-card"><div class="stats-card-value">${totalHours.toFixed(1)}</div><div class="stats-card-label">Total Hours Scheduled</div></div>
                <div class="stats-card"><div class="stats-card-value">${busiestDay ? dayDisplayNames[days.indexOf(busiestDay[0])] : 'N/A'}</div><div class="stats-card-label">Busiest Day</div></div>`;
        }
        
        function toggleAnalytics() {
            const panels = document.getElementById('analyticsPanels');
            const btn = document.querySelector('.analytics-toggle-btn');
            const isExpanded = panels.classList.toggle('expanded');
            btn.classList.toggle('expanded', isExpanded);
            btn.querySelector('.toggle-icon').style.transform = isExpanded ? 'rotate(180deg)' : 'rotate(0deg)';
            btn.querySelector('span:last-child').textContent = isExpanded ? 'Hide Analytics' : 'Show Analytics';
        }

        function switchAnalyticsTab(event, tabName) {
            document.querySelectorAll('.analytics-tab').forEach(t => t.classList.remove('active'));
            event.currentTarget.classList.add('active');
            document.querySelectorAll('.analytics-panel').forEach(p => p.classList.remove('active'));
            document.getElementById(`${tabName}-panel`).classList.add('active');
        }
        
        function setupKeyboardShortcuts() {
            window.addEventListener('keydown', (e) => {
                if(document.activeElement.tagName === 'INPUT') return;
                switch(e.key) {
                    case 'f': toggleFullscreen(); break;
                    case 'r': resetView(); break;
                    case 'p': exportView(); break;
                    case '+': case '=': e.preventDefault(); adjustZoom(0.1); break;
                    case '-': case '_': e.preventDefault(); adjustZoom(-0.1); break;
                    case 'Escape': document.getElementById('navPanel').classList.remove('show'); break;
                }
            });
        }

        async function initializeApp() {
            applyTheme(currentTheme);
            createTimetableGrid();
            setScheduleType('combined');
            
            try {
                const response = await fetch('timetable.json');
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                const data = await response.json();
                if (!data || !data.lessons) throw new Error('Invalid JSON format');
                
                timetableData = data;
                timetableData.lessons.forEach((lesson, i) => lesson.lessonId = `l-${i}-${lesson.teacherId}-${lesson.groupId}-${lesson.day}-${lesson.startTime}`);
                
                updateEntitySelector();
                filterLessons();
                setupSearch();
                setupKeyboardShortcuts();
                focusCurrentTime();
            } catch (error) {
                showErrorMessage(`Could not load or parse timetable data. ${error.message}. Please ensure you are connected to the internet and that the data source is available.`);
            }

            document.getElementById('viewType').addEventListener('change', () => {
                updateEntitySelector();
                filterLessons();
                document.getElementById('entitySearch').value = '';
            });
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.body.addEventListener('mousemove', positionTooltip);
            setInterval(focusCurrentTime, 60000);
        }

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>